<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Gestão de Cartões — Completo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#000; --card:#000; --accent:#fff; --muted:#ccc;
      --success:#1a9a3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:#fff;
    }
    .wrap{max-width:1100px; margin:32px auto; padding:20px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    .card{background:var(--card); border-radius:10px; padding:18px; box-shadow:0 0 0 2px #fff;}
    .login-grid{max-width:420px;margin:0 auto}
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"], select{
      width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #fff;
      font-size:14px; background:#000; color:#fff;
    }
    button{padding:10px 12px;border-radius:6px;border:1px solid #fff;background:var(--accent);color:#000;cursor:pointer}
    button.secondary{background:#555;color:#fff;border:1px solid #fff}
    .hidden{display:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{padding:8px;border:1px solid #fff;text-align:left;font-size:13px;color:#fff}
    th{background:#111}
    tr:nth-child(even){background:#222}
    .admin-only{display:none}
    .small {font-size:12px;color:#ccc}
    .top-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .file-input{display:inline-block;color:#000}
    @media(max-width:820px){
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gestão de Cartões</h1>
      <div>
        <span id="userEmailDisplay" class="small"></span>
        <button id="logoutBtn" class="secondary hidden" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- Login -->
    <section id="loginSection" class="card login-grid">
      <h2 style="margin:0 0 12px 0">Login</h2>
      <input id="inputEmail" type="email" placeholder="Email" />
      <input id="inputPassword" type="password" placeholder="Senha" />
      <div class="actions">
        <button onclick="login()">Entrar</button>
      </div>
      <p id="loginError" class="small" style="color:#b00020"></p>
    </section>

    <!-- Change password (first login) -->
    <section id="firstLoginSection" class="card hidden" style="max-width:520px;margin:18px auto;">
      <h2 style="margin-top:0">Primeiro acesso — alterar senha</h2>
      <p class="small">Para segurança, defina uma nova senha antes de acessar o sistema.</p>
      <input id="newPassword" type="password" placeholder="Nova senha (mínimo 6 caracteres)" />
      <input id="confirmNewPassword" type="password" placeholder="Confirme a nova senha" />
      <div class="actions">
        <button onclick="handleFirstLoginSetPassword()">Salvar nova senha</button>
      </div>
      <p id="firstLoginMsg" class="small" style="color:#b00020"></p>
    </section>

    <!-- App -->
    <section id="appSection" class="card hidden" style="margin-top:20px;">
      <div class="top-row">
        <div style="flex:1">
          <h2 style="margin:0 0 6px 0">Lista de Cartões</h2>
          <p class="small">A tabela abaixo mostra os cartões que você tem permissão para visualizar.</p>
        </div>

        <!-- Admin actions -->
        <div id="adminControls" class="admin-only" style="text-align:right">
          <div style="margin-bottom:8px">
            <button onclick="showAddForm()">Inserir Cartão</button>
            <button onclick="deleteAllExceptProtected()" style="background:#b00020">Deletar Todos</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="csvFileInput" class="file-input" type="file" accept=".csv" />
            <button onclick="runCSV()" title="Importar CSV (admin)">Executar CSV</button>
          </div>
        </div>
      </div>

      <!-- Add/Edit form (admin only) -->
      <div id="cardForm" class="hidden" style="margin-top:12px;border:2px solid #fff;padding:12px;border-radius:8px">
        <h3 style="margin:0 0 8px 0">Inserir / Editar Cartão</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <input id="f_nome" placeholder="Nome do Cliente" />
          <input id="f_cpf" placeholder="CPF" />
          <input id="f_regional" placeholder="Regional" />
          <input id="f_unidade" placeholder="Unidade" />
          <input id="f_assessor" placeholder="Assessor" />
          <input id="f_areaPlantada" placeholder="Área Plantada" />
          <input id="f_limiteConcedido" type="number" placeholder="Limite Concedido" />
          <input id="f_limiteDisponivel" type="number" placeholder="Limite Disponível" />
          <select id="f_statusLogistico">
            <option value="">Status Logístico</option>
            <option>1 -</option>
            <option>2 - Aguardando receber plástico na TC (Ijuí)</option>
            <option>3 - Aguardando receber plástico na TC (Sinop)</option>
            <option>3.5 - Na TC Ijuí</option>
            <option>4 - Em Trânsito para a unidade</option>
            <option>5 - Aguardando Entrega ao cliente</option>
            <option>6 - Cartão Não Entregue</option>
            <option>7 - Cartão Entregue</option>
            <option>8 - Não se Aplica</option>
          </select>
          <select id="f_statusLimite">
            <option value="">Status Limite</option>
            <option>01 - Limite - Aguardando análise</option>
            <option>02 - Limite - Análise de Crédito</option>
            <option>03 - Limite - Aguardando retorno do GU</option>
            <option>04 - Limite - Aguardando Validação Eduardo</option>
            <option>05 - Limite Aprovado - Aguardando Solicitação App. (DESUSO)</option>
            <option>06 - Limite - Aguardando aprovar limite Sinqia</option>
            <option>07 - Limite - Aguardando aprovar limite WM</option>
            <option>08 - Limite Aprovado - Aguardando matrícula (DESUSO)</option>
            <option>09 - Limite Aprovado - Aguardando envio de contrato</option>
            <option>10 - Limite Aprovado - Aguardando assinatura do contrato</option>
            <option>11 - Limite Aprovado - Aguardando assinatura renovação</option>
            <option>12 - Aguardando desbloqueio</option>
            <option>13 - Desbloqueado sem utilização</option>
            <option>14 - Ativo</option>
            <option>15 - Limite - Cancelado</option>
            <option>99 - NEGADO WM</option>
          </select>
          <input id="f_vencimento" type="date" />
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button onclick="saveCard()">Salvar</button>
          <button class="secondary" onclick="hideAddForm()">Cancelar</button>
        </div>
        <p id="formMsg" class="small" style="color:#b00020"></p>
      </div>

      <!-- Table -->
      <div style="overflow:auto;margin-top:12px">
        <table id="cardsTable">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>CPF</th>
              <th>Status Logístico</th>
              <th>Status Limite</th>
              <th>Área Plantada</th>
              <th>Regional</th>
              <th>Unidade</th>
              <th>Assessor</th>
              <th>Limite Concedido</th>
              <th>Limite Disponível</th>
              <th>% Disponível</th>
              <th>Vencimento</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="cardsTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKw2vWc6hwICs-yCsdqr1h4M1hmMUD0wE",
      authDomain: "limites-fd5a6.firebaseapp.com",
      projectId: "limites-fd5a6",
      storageBucket: "limites-fd5a6.firebasestorage.app",
      messagingSenderId: "51777731197",
      appId: "1:51777731197:web:dbc68948e1825cc2aecf14"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const PROTECTED_DOC_ID = "CB0WCT2tC1R7juMQ3sT9";
    const unidadesPorUsuario = {
      "usuario1@teste.com": ["A","B"],
      "usuario2@teste.com": ["C"]
    };

    let currentUser = null;
    let csvFile = null;
    let editingDocId = null;

    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const firstLoginSection = document.getElementById("firstLoginSection");
    const userEmailDisplay = document.getElementById("userEmailDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminControls = document.getElementById("adminControls");
    const cardsTbody = document.getElementById("cardsTbody");
    const cardForm = document.getElementById("cardForm");
    const csvInput = document.getElementById("csvFileInput");

    csvInput.addEventListener("change",(e)=>{csvFile=e.target.files[0];});

    onAuthStateChanged(auth, async (user)=>{
      currentUser=user;
      if(user){
        userEmailDisplay.textContent=user.email;
        logoutBtn.classList.remove("hidden");

        const userDocRef = doc(db,"Usuarios",user.uid);
        let isFirstLogin=true;
        try{
          const userSnap = await getDoc(userDocRef);
          if(userSnap.exists()) isFirstLogin=false;
        }catch(err){alert("Erro ao verificar usuário: "+err.message);}

        if(isFirstLogin){
          loginSection.classList.add("hidden");
          firstLoginSection.classList.remove("hidden");
          appSection.classList.add("hidden");
        }else{
          loginSection.classList.add("hidden");
          firstLoginSection.classList.add("hidden");
          appSection.classList.remove("hidden");
          if(user.email==="teste@teste.com.br"){
            document.querySelectorAll(".admin-only").forEach(el=>el.style.display="block");
          }
          await carregarCartoes();
        }
      }else{
        loginSection.classList.remove("hidden");
        firstLoginSection.classList.add("hidden");
        appSection.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        userEmailDisplay.textContent="";
      }
    });

    async function login(){
      const email = document.getElementById("inputEmail").value.trim();
      const senha = document.getElementById("inputPassword").value;
      document.getElementById("loginError").textContent="";
      if(!email||!senha){document.getElementById("loginError").textContent="Informe email e senha.";return;}
      try{await signInWithEmailAndPassword(auth,email,senha);}catch(err){document.getElementById("loginError").textContent=err.message;}
    }

    async function handleFirstLoginSetPassword(){
      const np=document.getElementById("newPassword").value;
      const cp=document.getElementById("confirmNewPassword").value;
      const msgEl=document.getElementById("firstLoginMsg");
      msgEl.textContent="";
      if(!np||np.length<6){msgEl.textContent="Senha deve ter ao menos 6 caracteres.";return;}
      if(np!==cp){msgEl.textContent="Senhas não conferem.";return;}
      if(!currentUser){msgEl.textContent="Usuário não autenticado.";return;}
      try{
        await updatePassword(currentUser,np);
        await setDoc(doc(db,"Usuarios",currentUser.uid),{primeiroLogin:true,email:currentUser.email});
        firstLoginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        if(currentUser.email==="teste@teste.com.br"){
          document.querySelectorAll(".admin-only").forEach(el=>el.style.display="block");
        }
        await carregarCartoes();
      }catch(err){msgEl.textContent="Erro: "+err.message;}
    }

    async function carregarCartoes(){
      cardsTbody.innerHTML="";
      try{
        const snapshot = await getDocs(collection(db,"Cartao"));
        snapshot.forEach(s=>{
          const c=s.data();
          const tr=document.createElement("tr");
          const perc=c.limiteConcedido?((c.limiteDisponivel/c.limiteConcedido)*100).toFixed(2)+"%":"";
          tr.innerHTML=`
            <td>${c.nome||""}</td>
            <td>${c.cpf||""}</td>
            <td>${c.statusLogistico||""}</td>
            <td>${c.statusLimite||""}</td>
            <td>${c.areaPlantada||""}</td>
            <td>${c.regional||""}</td>
            <td>${c.unidade||""}</td>
            <td>${c.assessor||""}</td>
            <td>${c.limiteConcedido||""}</td>
            <td>${c.limiteDisponivel||""}</td>
            <td>${perc}</td>
            <td>${c.vencimento||""}</td>
            <td>
              <button onclick="editCard('${s.id}')">Editar</button>
              <button onclick="deleteCard('${s.id}')" style="background:#b00020">Deletar</button>
            </td>
          `;
          cardsTbody.appendChild(tr);
        });
      }catch(err){alert(err.message);}
    }

    function logout(){signOut(auth);}

    function showAddForm(){
      editingDocId=null;
      cardForm.classList.remove("hidden");
    }

    function hideAddForm(){cardForm.classList.add("hidden");}

    async function saveCard(){
      const data={
        nome:document.getElementById("f_nome").value,
        cpf:document.getElementById("f_cpf").value,
        regional:document.getElementById("f_regional").value,
        unidade:document.getElementById("f_unidade").value,
        assessor:document.getElementById("f_assessor").value,
        areaPlantada:document.getElementById("f_areaPlantada").value,
        limiteConcedido:Number(document.getElementById("f_limiteConcedido").value),
        limiteDisponivel:Number(document.getElementById("f_limiteDisponivel").value),
        statusLogistico:document.getElementById("f_statusLogistico").value,
        statusLimite:document.getElementById("f_statusLimite").value,
        vencimento:document.getElementById("f_vencimento").value
      };
      try{
        if(editingDocId) await updateDoc(doc(db,"Cartao",editingDocId),data);
        else await addDoc(collection(db,"Cartao"),data);
        hideAddForm(); await carregarCartoes();
      }catch(err){alert(err.message);}
    }

    async function editCard(id){
      editingDocId=id;
      const c = (await getDoc(doc(db,"Cartao",id))).data();
      document.getElementById("f_nome").value=c.nome||"";
      document.getElementById("f_cpf").value=c.cpf||"";
      document.getElementById("f_regional").value=c.regional||"";
      document.getElementById("f_unidade").value=c.unidade||"";
      document.getElementById("f_assessor").value=c.assessor||"";
      document.getElementById("f_areaPlantada").value=c.areaPlantada||"";
      document.getElementById("f_limiteConcedido").value=c.limiteConcedido||"";
      document.getElementById("f_limiteDisponivel").value=c.limiteDisponivel||"";
      document.getElementById("f_statusLogistico").value=c.statusLogistico||"";
      document.getElementById("f_statusLimite").value=c.statusLimite||"";
      document.getElementById("f_vencimento").value=c.vencimento||"";
      showAddForm();
    }

    async function deleteCard(id){
      if(confirm("Confirma deletar?")){await deleteDoc(doc(db,"Cartao",id)); await carregarCartoes();}
    }

    async function deleteAllExceptProtected(){
      if(!confirm("Confirma deletar todos os cartões exceto protegido?")) return;
      const snapshot = await getDocs(collection(db,"Cartao"));
      for(const s of snapshot.docs){
        if(s.id!==PROTECTED_DOC_ID) await deleteDoc(doc(db,"Cartao",s.id));
      }
      await carregarCartoes();
    }

    async function runCSV(){if(!csvFile){alert("Escolha arquivo CSV");return;} alert("Função CSV pronta para implementar");}

    window.login = login;
window.logout = logout;
window.handleFirstLoginSetPassword = handleFirstLoginSetPassword;
window.showAddForm = showAddForm;
window.hideAddForm = hideAddForm;
window.saveCard = saveCard;
window.editCard = editCard;
window.deleteCard = deleteCard;
window.deleteAllExceptProtected = deleteAllExceptProtected;
window.runCSV = runCSV;
  </script>
</body>
</html>

