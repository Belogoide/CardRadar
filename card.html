<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gestão de Cartões</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBKw2vWc6hwICs-yCsdqr1h4M1hmMUD0wE",
  authDomain: "limites-fd5a6.firebaseapp.com",
  projectId: "limites-fd5a6",
  storageBucket: "limites-fd5a6.firebasestorage.app",
  messagingSenderId: "51777731197",
  appId: "1:51777731197:web:dbc68948e1825cc2aecf14"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let userEmail = "";
let userUnits = []; // Unidades do usuário

// --- Carregar Cartões ---
async function carregarCartoes() {
  const snapshot = await getDocs(collection(db, "Cartao"));
  const tbody = document.querySelector("#cartoes-body");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap => {
    const c = docSnap.data();
    if(userEmail !== "teste@teste.com.br" && !userUnits.includes(c.unidade)) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.nome}</td>
      <td>${c.cpf || ''}</td>
      <td>${c.statusLogistico || ''}</td>
      <td>${c.statusLimite || ''}</td>
      <td>${c.areaPlantada || ''}</td>
      <td>${c.regional || ''}</td>
      <td>${c.unidade || ''}</td>
      <td>${c.assessor || ''}</td>
      <td>${c.limiteConcedido}</td>
      <td>${c.limiteDisponivel}</td>
      <td>${c.percentualDisponivel}%</td>
      <td>${c.vencimento ? new Date(c.vencimento).toLocaleDateString("pt-BR") : ''}</td>
      ${userEmail === "teste@teste.com.br" ? `<td><button onclick="atualizarCartao('${docSnap.id}')">Atualizar</button></td>` : ''}
    `;
    tbody.appendChild(tr);
  });
}

// --- Inserir Cartão ---
async function inserirCartao() {
  if(userEmail !== "teste@teste.com.br") return alert("Apenas o administrador pode inserir cartões.");
  const nome = prompt("Nome do Cliente:");
  const cpf = prompt("CPF:");
  const unidade = prompt("Unidade:");
  const area = prompt("Área Plantada:");
  const limiteConcedido = parseFloat(prompt("Limite Concedido:")) || 0;
  const limiteDisponivel = parseFloat(prompt("Limite Disponível:")) || 0;
  const percentualDisponivel = ((limiteDisponivel/limiteConcedido)*100).toFixed(2);
  await addDoc(collection(db, "Cartao"), {
    nome, cpf, unidade, area,
    limiteConcedido, limiteDisponivel, percentualDisponivel,
    statusLogistico: "", statusLimite: "",
    historico: [], vencimento: null
  });
  carregarCartoes();
}

// --- Atualizar Cartão ---
async function atualizarCartao(docId) {
  if(userEmail !== "teste@teste.com.br") return alert("Apenas o administrador pode atualizar cartões.");
  const sLogistico = prompt("Status Logístico:");
  const sLimite = prompt("Status Limite:");
  await updateDoc(doc(db, "Cartao", docId), {
    statusLogistico: sLogistico,
    statusLimite: sLimite,
    historico: arrayUnion({data:new Date().toISOString(), statusLogistico:sLogistico, statusLimite:sLimite})
  });
  carregarCartoes();
}

// --- CSV ---
let csvFile;
function importarCSV(input) { csvFile = input.files[0]; }

async function executarCSV() {
  if(userEmail !== "teste@teste.com.br") return alert("Apenas o administrador pode executar CSV.");
  if(!csvFile) return alert("Selecione um CSV!");
  const text = await csvFile.text();
  const lines = text.split("\n").filter(l=>l.trim()!=="");
  const headers = lines[0].split(";").map(h=>h.trim());
  for(let i=1;i<lines.length;i++){
    const row = lines[i].split(";");
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = row[idx]?.trim() || "");
    let vencimento = obj["Vencimento do limite"] ? new Date(obj["Vencimento do limite"]) : null;
    await addDoc(collection(db, "Cartao"), {
      nome: obj["Cliente"],
      cpf: obj["CPF"],
      unidade: obj["Unidade 3Tentos"],
      areaPlantada: obj["Area Plantada"],
      limiteConcedido: parseFloat(obj["Limite Concedido"])||0,
      limiteDisponivel: parseFloat(obj["Limite Disponivel"])||0,
      percentualDisponivel: parseFloat(obj["% do Limite Disponivel"])||0,
      statusLogistico: obj["Status Logistico"] || "",
      statusLimite: obj["Status Limite"] || "",
      vencimento: vencimento ? vencimento.toISOString() : null,
      historico: []
    });
  }
  carregarCartoes();
}

// --- Login ---
async function loginSistema() {
  const email = document.getElementById("login-email").value;
  const senha = document.getElementById("login-senha").value;
  try {
    const uc = await signInWithEmailAndPassword(auth,email,senha);
    const user = uc.user;
    userEmail = user.email;

    // Primeiro login
    const userRef = doc(db,"Usuarios",user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{primeiroLogin:false});
    }
    const data = (await getDoc(userRef)).data();
    if(!data.primeiroLogin){
      let nova = prompt("Primeiro login: defina nova senha");
      if(!nova) return alert("Senha não definida");
      await updatePassword(user,nova);
      await updateDoc(userRef,{primeiroLogin:true});
      alert("Senha alterada! Faça login novamente.");
      return;
    }

    // Unidades usuário comum
    if(userEmail !== "teste@teste.com.br"){
      if(userEmail=="usuario1@teste.com") userUnits=["A","B"];
      if(userEmail=="usuario2@teste.com") userUnits=["C"];
    }

    document.getElementById("login-container").style.display="none";
    document.getElementById("app").style.display="block";
    carregarCartoes();
  } catch(err){
    alert("Erro: "+err.message);
  }
}

window.loginSistema = loginSistema;
window.carregarCartoes = carregarCartoes;
window.inserirCartao = inserirCartao;
window.atualizarCartao = atualizarCartao;
window.importarCSV = importarCSV;
window.executarCSV = executarCSV;

</script>
<style>
body{background:black;color:white;font-family:Arial,sans-serif;margin:0;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid white;padding:8px;text-align:center;}
button,.btn{background:white;color:black;border:none;padding:5px 10px;cursor:pointer;border-radius:6px;margin:5px;}
input,select{width:100%;padding:6px;margin:5px 0;border:1px solid white;border-radius:4px;background:black;color:white;}
#login-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:30px;border-radius:10px;text-align:center;width:300px;}
#login-container h2{margin-bottom:20px;}
</style>
</head>
<body>
<div id="login-container">
  <h2>Login</h2>
  <input type="email" id="login-email" placeholder="Email">
  <input type="password" id="login-senha" placeholder="Senha">
  <button onclick="loginSistema()">Entrar</button>
</div>

<div id="app" style="display:none;padding:20px;">
  <h1>Gestão de Cartões</h1>
  <button onclick="inserirCartao()">Inserir Cartão</button>
  <input type="file" accept=".csv" onchange="importarCSV(this)">
  <button onclick="executarCSV()">Executar CSV</button>
  <table>
    <thead>
      <tr>
        <th>Cliente</th><th>CPF</th><th>Status Logístico</th><th>Status Limite</th>
        <th>Área Plantada</th><th>Regional</th><th>Unidade</th><th>Assessor</th>
        <th>Limite Concedido</th><th>Limite Disponível</th><th>% Disponível</th><th>Vencimento</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="cartoes-body"></tbody>
  </table>
</div>
</body>
</html>
