<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gestão de Cartões</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBKw2vWc6hwICs-yCsdqr1h4M1hmMUD0wE",
  authDomain: "limites-fd5a6.firebaseapp.com",
  projectId: "limites-fd5a6",
  storageBucket: "limites-fd5a6.firebasestorage.app",
  messagingSenderId: "51777731197",
  appId: "1:51777731197:web:dbc68948e1825cc2aecf14"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Opções fixas
const regionais = ["1","2","3"];
const unidadesPorRegional = { "1": ["A","B","C"], "2": ["D","E","F"], "3": ["G","H","I"] };
const assessoresPorRegional = { "1": ["Joao"], "2": ["Pedro"], "3": ["Carlos"] };
const statusLogisticoOptions = [
  "1 -","2 - Aguardando receber plástico na TC (Ijuí)","3 - Aguardando receber plástico na TC (Sinop)",
  "3.5 - Na TC Ijuí","4 - Em Trânsito para a unidade","5 - Aguardando Entrega ao cliente",
  "6 - Cartão Não Entregue","7 - Cartão Entregue","8 - Não se Aplica"
];
const statusLimiteOptions = [
  "01 - Limite - Aguardando análise","02 - Limite - Análise de Crédito","03 - Limite - Aguardando retorno do GU",
  "04 - Limite - Aguardando Validação Eduardo","05 - Limite Aprovado - Aguardando Solicitação App. (DESUSO)",
  "06 - Limite - Aguardando aprovar limite Sinqia","07 - Limite - Aguardando aprovar limite WM",
  "08 - Limite Aprovado - Aguardando matrícula (DESUSO)","09 - Limite Aprovado - Aguardando envio de contrato",
  "10 - Limite Aprovado - Aguardando assinatura do contrato","11 - Limite Aprovado - Aguardando assinatura renovação",
  "12 - Aguardando desbloqueio","13 - Desbloqueado sem utilização","14 - Ativo","15 - Limite - Cancelado","99 - NEGADO WM"
];

// Parse data dd/mm/yyyy para ISO
function parseDataCSV(dataStr) {
  if (!dataStr || dataStr.trim() === "") return null;
  const partes = dataStr.split("/");
  if (partes.length !== 3) return null;
  const d = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
  return isNaN(d) ? null : d.toISOString();
}

// Carregar cartões
async function carregarCartoes() {
  const snapshot = await getDocs(collection(db, "Cartao"));
  const tbody = document.querySelector("#cartoes-body");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap => {
    const c = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.nome}</td>
      <td>${c.cpf || ''}</td>
      <td>${c.userId || ''}</td>
      <td>${c.statusLogistico || ''}</td>
      <td>${c.statusLimite || ''}</td>
      <td>${c.areaPlantada || ''}</td>
      <td>${c.regional || ''}</td>
      <td>${c.unidade || ''}</td>
      <td>${c.assessor || ''}</td>
      <td>${c.limiteConcedido}</td>
      <td>${c.limiteDisponivel}</td>
      <td>${c.percentualDisponivel}%</td>
      <td>${c.vencimento ? new Date(c.vencimento).toLocaleDateString("pt-BR") : ''}</td>
      <td><button class="btn-update">Atualizar Status</button></td>
    `;
    tbody.appendChild(tr);
    tr.querySelector(".btn-update").addEventListener("click", () => atualizarCartao(docSnap.id));
  });
}

// Inserir cartão
async function inserirCartao() {
  const nome = prompt("Nome do Cliente:");
  const cpf = prompt("CPF:");
  const userId = prompt("User ID:");
  const regional = prompt("Regional (1,2,3):");
  const unidade = prompt("Unidade:");
  const assessor = prompt("Assessor:");
  const areaPlantada = prompt("Área Plantada:");
  const limiteConcedido = parseFloat(prompt("Limite Concedido:"));
  const limiteDisponivel = parseFloat(prompt("Limite Disponível:"));
  const percentualDisponivel = ((limiteDisponivel/limiteConcedido)*100).toFixed(2);
  const statusLogistico = prompt("Status Logístico:");
  const statusLimite = prompt("Status Limite:");
  const vencimentoInput = prompt("Data de Vencimento (dd/mm/yyyy):");
  const vencimento = parseDataCSV(vencimentoInput);

  await addDoc(collection(db, "Cartao"), {
    nome, cpf, userId, regional, unidade, assessor, areaPlantada,
    limiteConcedido, limiteDisponivel, percentualDisponivel,
    statusLogistico, statusLimite, vencimento,
    historico: [], primeiroLogin:false
  });
  alert("Cartão salvo com sucesso!");
  carregarCartoes();
}

// Atualizar Status
async function atualizarCartao(id) {
  const sLogistico = prompt("Atualizar Status Logístico:");
  const sLimite = prompt("Atualizar Status Limite:");
  const ref = doc(db, "Cartao", id);
  await updateDoc(ref, {
    statusLogistico: sLogistico,
    statusLimite: sLimite,
    historico: arrayUnion({
      data: new Date().toISOString(),
      statusLogistico: sLogistico,
      statusLimite: sLimite
    })
  });
  alert("Status atualizado!");
  carregarCartoes();
}

// Importar CSV
async function importarCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const text = await file.text();
  const linhas = text.split(/\r?\n/);
  linhas.shift(); // remove header
  for (const linha of linhas) {
    if (!linha.trim()) continue;
    const campos = linha.split(";");
    const vencimento = parseDataCSV(campos[12]);
    await addDoc(collection(db, "Cartao"), {
      nome: campos[0], cpf: campos[1], userId: campos[2], statusLogistico: campos[3], statusLimite: campos[4],
      areaPlantada: campos[5], regional: campos[6], unidade: campos[7], assessor: campos[8],
      limiteConcedido: parseFloat(campos[9]), limiteDisponivel: parseFloat(campos[10]),
      percentualDisponivel: parseFloat(campos[11]), vencimento, historico: [], primeiroLogin:false
    });
  }
  alert("CSV importado com sucesso!");
  carregarCartoes();
}

// Deletar todos exceto fixo
async function deletarTudo() {
  const snapshot = await getDocs(collection(db, "Cartao"));
  for (const docSnap of snapshot.docs) {
    if (docSnap.id !== "CB0WCT2tC1R7juMQ3sT9") await deleteDoc(doc(db, "Cartao", docSnap.id));
  }
  alert("Todos os documentos (exceto o fixo) foram deletados!");
  carregarCartoes();
}

// Login
async function loginFunc() {
  const email = document.getElementById("login-email").value;
  const senha = document.getElementById("login-senha").value;
  try {
    await signInWithEmailAndPassword(auth, email, senha);
    document.getElementById("login-container").style.display="none";
    document.getElementById("app").style.display="block";
    carregarCartoes();
  } catch(err) { alert("Erro no login: "+err.message);}
}

window.onload = () => {
  document.getElementById('csv-file').addEventListener('change', importarCSV);
  document.getElementById('login-btn').addEventListener('click', loginFunc);
};
</script>

<style>
body { background-color: black; color: white; font-family: Arial, sans-serif; margin:0; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid white; padding: 8px; text-align: center; }
button, .btn { background: white; color: black; border: none; padding: 5px 10px; cursor: pointer; border-radius: 6px; }
button:hover, .btn:hover { opacity:0.9; }
input, select { width: 90%; padding: 5px; margin: 5px 0; border: 1px solid white; border-radius:5px; background:black; color:white; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; }
.modal-content { background: #222; padding: 20px; border-radius: 10px; text-align: center; }
#login-container { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; flex-direction:column; }
#login-box { background:#111; padding:20px; border-radius:10px; display:flex; flex-direction:column; align-items:center; }
</style>
</head>
<body>

<div id="login-container">
  <div id="login-box">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-senha" placeholder="Senha">
    <button id="login-btn">Entrar</button>
  </div>
</div>

<div id="app" style="display:none">
<h1>Gestão de Cartões</h1>
<input type="file" id="csv-file" accept=".csv">
<button class="btn" onclick="document.getElementById('csv-file').click()">Importar CSV</button>
<button class="btn" onclick="deletarTudo()">Deletar Tudo</button>
<button class="btn" onclick="inserirCartao()">Inserir Cartão</button>
<table>
  <thead>
    <tr>
      <th>Cliente</th><th>CPF</th><th>User ID</th><th>Status Logístico</th><th>Status Limite</th>
      <th>Área Plantada</th><th>Regional</th><th>Unidade</th><th>Assessor</th>
      <th>Limite Concedido</th><th>Limite Disponível</th><th>% Disponível</th><th>Vencimento</th><th>Ações</th>
    </tr>
  </thead>
  <tbody id="cartoes-body"></tbody>
</table>
</div>
</body>
</html>
