<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gestão de Cartões</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, arrayUnion, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBKw2vWc6hwICs-yCsdqr1h4M1hmMUD0wE",
  authDomain: "limites-fd5a6.firebaseapp.com",
  projectId: "limites-fd5a6",
  storageBucket: "limites-fd5a6.firebasestorage.app",
  messagingSenderId: "51777731197",
  appId: "1:51777731197:web:dbc68948e1825cc2aecf14"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Opções fixas
const regionais = ["1","2","3"];
const unidadesPorRegional = { "1":["A","B","C"], "2":["D","E","F"], "3":["G","H","I"] };
const assessoresPorRegional = { "1":["Joao"], "2":["Pedro"], "3":["Carlos"] };
const statusLogisticoOptions = [
  "1 -","2 - Aguardando receber plástico na TC (Ijuí)","3 - Aguardando receber plástico na TC (Sinop)",
  "3.5 - Na TC Ijuí","4 - Em Trânsito para a unidade","5 - Aguardando Entrega ao cliente",
  "6 - Cartão Não Entregue","7 - Cartão Entregue","8 - Não se Aplica"
];
const statusLimiteOptions = [
  "01 - Limite - Aguardando análise","02 - Limite - Análise de Crédito","03 - Limite - Aguardando retorno do GU",
  "04 - Limite - Aguardando Validação Eduardo","05 - Limite Aprovado - Aguardando Solicitação App. (DESUSO)",
  "06 - Limite - Aguardando aprovar limite Sinqia","07 - Limite - Aguardando aprovar limite WM",
  "08 - Limite Aprovado - Aguardando matrícula (DESUSO)","09 - Limite Aprovado - Aguardando envio de contrato",
  "10 - Limite Aprovado - Aguardando assinatura do contrato","11 - Limite Aprovado - Aguardando assinatura renovação",
  "12 - Aguardando desbloqueio","13 - Desbloqueado sem utilização","14 - Ativo","15 - Limite - Cancelado","99 - NEGADO WM"
];

// Popup genérico
function perguntar(titulo, tipo="text", opcoes=[]) {
  return new Promise(resolve=>{
    const modal = document.createElement("div");
    modal.className="modal";
    modal.innerHTML=`
      <div class="modal-content">
        <h3>${titulo}</h3>
        ${tipo==="select" ? `<select id="modal-input">${opcoes.map(o=>`<option value="${o}">${o}</option>`).join("")}</select>` : `<input type="${tipo}" id="modal-input">`}
        <button class="btn" id="ok-btn">OK</button>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("ok-btn").onclick=()=>{
      const valor=document.getElementById("modal-input").value;
      modal.remove();
      resolve(valor);
    };
  });
}

// Carregar cartões
async function carregarCartoes() {
  const snapshot=await getDocs(collection(db,"Cartao"));
  const tbody=document.querySelector("#cartoes-body");
  tbody.innerHTML="";
  snapshot.forEach(docSnap=>{
    const c=docSnap.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.nome}</td>
      <td>${c.cpf||''}</td>
      <td>${c.userId||''}</td>
      <td>${c.statusLogistico||''}</td>
      <td>${c.statusLimite||''}</td>
      <td>${c.areaPlantada||''}</td>
      <td>${c.regional||''}</td>
      <td>${c.unidade||''}</td>
      <td>${c.assessor||''}</td>
      <td>${c.limiteConcedido}</td>
      <td>${c.limiteDisponivel}</td>
      <td>${c.percentualDisponivel}%</td>
      <td>${c.vencimento?new Date(c.vencimento).toLocaleDateString("pt-BR"):""}</td>
      <td><button class="btn" onclick="atualizarCartao('${docSnap.id}')">Atualizar Status</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Inserir cartão
async function inserirCartao() {
  const nome=await perguntar("Nome do Cliente:");
  const cpf=await perguntar("CPF:");
  const userId=await perguntar("User ID:");
  const regional=await perguntar("Regional:","select",regionais);
  const unidade=await perguntar("Unidade:","select",unidadesPorRegional[regional]);
  const assessor=await perguntar("Assessor:","select",assessoresPorRegional[regional]);
  const areaPlantada=await perguntar("Área Plantada:");
  const limiteConcedido=parseFloat(await perguntar("Limite Concedido:","number"));
  const limiteDisponivel=parseFloat(await perguntar("Limite Disponível:","number"));
  const percentualDisponivel=((limiteDisponivel/limiteConcedido)*100).toFixed(2);
  const statusLogistico=await perguntar("Status Logístico:","select",statusLogisticoOptions);
  const statusLimite=await perguntar("Status Limite:","select",statusLimiteOptions);
  const vencimentoInput=await perguntar("Data de Vencimento:","date");
  const vencimento=vencimentoInput?new Date(vencimentoInput).toISOString():null;

  await addDoc(collection(db,"Cartao"),{
    nome,cpf,userId,regional,unidade,assessor,areaPlantada,
    limiteConcedido,limiteDisponivel,percentualDisponivel,
    statusLogistico,statusLimite,vencimento,
    historico:[],primeiroLogin:false
  });
  alert("Cartão salvo com sucesso!");
  carregarCartoes();
}

// Atualizar
async function atualizarCartao(id){
  const sLogistico=await perguntar("Atualizar Status Logístico:","select",statusLogisticoOptions);
  const sLimite=await perguntar("Atualizar Status Limite:","select",statusLimiteOptions);
  const ref=doc(db,"Cartao",id);
  await updateDoc(ref,{
    statusLogistico:sLogistico,
    statusLimite:sLimite,
    historico:arrayUnion({data:new Date().toISOString(),statusLogistico:sLogistico,statusLimite:sLimite})
  });
  alert("Status atualizado!");
  carregarCartoes();
}

// Deletar tudo
async function deletarTudo(){
  if(!confirm("Deseja realmente apagar todos os registros?")) return;
  const snapshot=await getDocs(collection(db,"Cartao"));
  for(const docSnap of snapshot.docs){
    if(docSnap.id!=="CB0WCT2tC1R7juMQ3sT9"){
      await deleteDoc(doc(db,"Cartao",docSnap.id));
    }
  }
  alert("Registros deletados!");
  carregarCartoes();
}

// CSV
let arquivoCSV;
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById('csv-file').addEventListener('change',e=>{
    arquivoCSV=e.target.files[0];
  });
});
function parseDataCSV(str){const d=new Date(str);return isNaN(d.getTime())?null:d.toISOString();}
async function executarCSV(){
  if(!arquivoCSV){alert("Selecione CSV primeiro!");return;}
  const text=await arquivoCSV.text();
  const linhas=text.split(/\r?\n/);
  linhas.shift(); // cabeçalho
  for(const linha of linhas){
    if(!linha.trim()) continue;
    const campos=linha.split(";");
    await addDoc(collection(db,"Cartao"),{
      nome:campos[0],
      cpf:campos[1],
      userId:campos[2],
      statusLogistico:campos[3],
      statusLimite:campos[4],
      areaPlantada:campos[5],
      regional:campos[6],
      unidade:campos[7],
      assessor:campos[8],
      limiteConcedido:parseFloat(campos[9]),
      limiteDisponivel:parseFloat(campos[10]),
      percentualDisponivel:parseFloat(campos[11]),
      vencimento:parseDataCSV(campos[12]),
      historico:[],
      primeiroLogin:false
    });
  }
  alert("CSV importado com sucesso!");
  carregarCartoes();
}

// Login Sistema
async function loginSistema(){
  const email=document.getElementById("login-email").value;
  const senha=document.getElementById("login-senha").value;
  try{
    await signInWithEmailAndPassword(auth,email,senha);
    document.getElementById("login-container").style.display="none";
    document.getElementById("app").style.display="block";
    carregarCartoes();
  }catch(e){alert("Erro de login: "+e.message);}
}
</script>

<style>
body { background-color: black; color: white; font-family: Arial, sans-serif; margin:0; padding:0; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid white; padding: 8px; text-align: center; }
button, .btn { background: white; color: black; border: none; padding: 5px 10px; cursor: pointer; border-radius: 6px; margin: 5px; }
.modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; }
.modal-content { background:#222; padding:20px; border-radius:10px; text-align:center; }
select, input { width: 100%; padding: 8px; margin: 10px 0; border:1px solid white; background:black; color:white; }
#login-container { display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; }
#login-container input { width:200px; margin:5px 0; }
</style>
</head>
<body>

<div id="login-container">
<h2>Login</h2>
<input type="email" id="login-email" placeholder="Email">
<input type="password" id="login-senha" placeholder="Senha">
<button class="btn" onclick="loginSistema()">Entrar</button>
</div>

<div id="app" style="display:none; padding:20px;">
<h1>Gestão de Cartões</h1>
<button class="btn" onclick="inserirCartao()">Inserir Cliente/Cartão</button>
<button class="btn" onclick="deletarTudo()">Deletar Tudo</button>
<input type="file" id="csv-file" accept=".csv" style="display:none;">
<button class="btn" onclick="document.getElementById('csv-file').click()">Selecionar CSV</button>
<button class="btn" onclick="executarCSV()">Executar CSV</button>

<table>
<thead>
<tr>
<th>Cliente</th><th>CPF</th><th>User ID</th><th>Status Logístico</th><th>Status Limite</th>
<th>Área Plantada</th><th>Regional</th><th>Unidade</th><th>Assessor</th>
<th>Limite Concedido</th><th>Limite Disponível</th><th>% Disponível</th><th>Vencimento</th><th>Ações</th>
</tr>
</thead>
<tbody id="cartoes-body"></tbody>
</table>
</div>

</body>
</html>
