<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Gestão de Cartões — Completo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--bg:#000;--card:#111;--accent:#fff;--muted:#ccc;--success:#1a9a3b;}
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff;}
.wrap{max-width:1100px;margin:32px auto;padding:20px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
header h1{margin:0;font-size:20px;color:var(--accent)}
.card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 0 0 2px #fff;}
.login-grid{max-width:420px;margin:0 auto;}
input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"], select{
width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #fff;font-size:14px;background:#000;color:#fff;}
button{padding:10px 12px;border-radius:6px;border:1px solid #fff;background:var(--accent);color:#000;cursor:pointer}
button.secondary{background:#555;color:#fff;border:1px solid #fff}
.hidden{display:none}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border:1px solid #fff;text-align:left;font-size:13px;color:#fff}
th{background:#111}
tr:nth-child(even){background:#222}
.admin-only{display:none}
.small{font-size:12px;color:#ccc}
.top-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.file-input{display:inline-block;color:#000}
@media(max-width:820px){header{flex-direction:column;align-items:flex-start;gap:8px}}
</style>
</head>
<body>
<div class="wrap">
<header>
<h1>Gestão de Cartões</h1>
<div>
<span id="userEmailDisplay" class="small"></span>
<button id="logoutBtn" class="secondary hidden" onclick="logout()">Sair</button>
</div>
</header>

<!-- Login -->
<section id="loginSection" class="card login-grid">
<h2>Login</h2>
<input id="inputEmail" type="email" placeholder="Email">
<input id="inputPassword" type="password" placeholder="Senha">
<div class="actions">
<button onclick="login()">Entrar</button>
</div>
<p id="loginError" class="small" style="color:#b00020"></p>
</section>

<!-- Primeiro login -->
<section id="firstLoginSection" class="card hidden" style="max-width:520px;margin:18px auto;">
<h2>Primeiro acesso — alterar senha</h2>
<p class="small">Para segurança, defina uma nova senha antes de acessar o sistema.</p>
<input id="newPassword" type="password" placeholder="Nova senha (mínimo 6 caracteres)">
<input id="confirmNewPassword" type="password" placeholder="Confirme a nova senha">
<div class="actions">
<button onclick="handleFirstLoginSetPassword()">Salvar nova senha</button>
</div>
<p id="firstLoginMsg" class="small" style="color:#b00020"></p>
</section>

<!-- App -->
<section id="appSection" class="card hidden" style="margin-top:20px;">
<div class="top-row">
<div style="flex:1">
<h2>Lista de Cartões</h2>
<p class="small">A tabela abaixo mostra os cartões que você tem permissão para visualizar.</p>
</div>
<div id="adminControls" class="admin-only" style="text-align:right">
<div style="margin-bottom:8px">
<button onclick="showAddForm()">Inserir Cartão</button>
<button onclick="deleteAllExceptProtected()" style="background:#b00020">Deletar Todos</button>
</div>
<div style="display:flex;gap:8px;align-items:center">
<input id="csvFileInput" class="file-input" type="file" accept=".csv">
<button onclick="runCSV()">Executar CSV</button>
</div>
</div>
</div>

<!-- Formulario de cadastro/edição -->
<div id="cardForm" class="hidden" style="margin-top:12px;border:2px solid #fff;padding:12px;border-radius:8px">
<h3>Inserir / Editar Cartão</h3>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
<input id="f_nome" placeholder="Nome do Cliente">
<input id="f_cpf" placeholder="CPF">
<input id="f_regional" placeholder="Regional">
<input id="f_unidade" placeholder="Unidade">
<input id="f_assessor" placeholder="Assessor">
<input id="f_areaPlantada" placeholder="Área Plantada">
<input id="f_limiteConcedido" type="number" placeholder="Limite Concedido">
<input id="f_limiteDisponivel" type="number" placeholder="Limite Disponível">
<select id="f_statusLogistico">
<option value="">Status Logístico</option>
<option>1 -</option>
<option>2 - Aguardando receber plástico na TC (Ijuí)</option>
<option>3 - Aguardando receber plástico na TC (Sinop)</option>
<option>3.5 - Na TC Ijuí</option>
<option>4 - Em Trânsito para a unidade</option>
<option>5 - Aguardando Entrega ao cliente</option>
<option>6 - Cartão Não Entregue</option>
<option>7 - Cartão Entregue</option>
<option>8 - Não se Aplica</option>
</select>
<select id="f_statusLimite">
<option value="">Status Limite</option>
<option>01 - Limite - Aguardando análise</option>
<option>02 - Limite - Análise de Crédito</option>
<option>03 - Limite - Aguardando retorno do GU</option>
<option>04 - Limite - Aguardando Validação Eduardo</option>
<option>05 - Limite Aprovado - Aguardando Solicitação App. (DESUSO)</option>
<option>06 - Limite - Aguardando aprovar limite Sinqia</option>
<option>07 - Limite - Aguardando aprovar limite WM</option>
<option>08 - Limite Aprovado - Aguardando matrícula (DESUSO)</option>
<option>09 - Limite Aprovado - Aguardando envio de contrato</option>
<option>10 - Limite Aprovado - Aguardando assinatura do contrato</option>
<option>11 - Limite Aprovado - Aguardando assinatura renovação</option>
<option>12 - Aguardando desbloqueio</option>
<option>13 - Desbloqueado sem utilização</option>
<option>14 - Ativo</option>
<option>15 - Limite - Cancelado</option>
<option>99 - NEGADO WM</option>
</select>
<input id="f_vencimento" type="date">
</div>
<div style="margin-top:10px;display:flex;gap:8px">
<button onclick="saveCard()">Salvar</button>
<button class="secondary" onclick="hideAddForm()">Cancelar</button>
</div>
<p id="formMsg" class="small" style="color:#b00020"></p>
</div>

<!-- Tabela -->
<div style="overflow:auto;margin-top:12px">
<table id="cardsTable">
<thead>
<tr>
<th>Cliente</th>
<th>CPF</th>
<th>Status Logístico</th>
<th>Status Limite</th>
<th>Área Plantada</th>
<th>Regional</th>
<th>Unidade</th>
<th>Assessor</th>
<th>Limite Concedido</th>
<th>Limite Disponível</th>
<th>% Disponível</th>
<th>Vencimento</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="cardsTbody"></tbody>
</table>
</div>
</section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, updatePassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBKw2vWc6hwICs-yCsdqr1h4M1hmMUD0wE",
authDomain:"limites-fd5a6.firebaseapp.com",
projectId:"limites-fd5a6",
storageBucket:"limites-fd5a6.appspot.com",
messagingSenderId:"51777731197",
appId:"1:51777731197:web:dbc68948e1825cc2aecf14"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let csvFile = null;
let currentUserEmail = "";

const userUnitsMap = {
"silmar.junior@3tentos.com.br":["Santa Bárbara do Sul","Saldanha Marinho","Colorado","Palmeira das Missões","Espumoso","Nonoai"],
"douglas.lodi@3tentos.com.br":["Passo Fundo","Lagoa Vermelha","Vacaria","Erechim","Sananduva"],
"giovana.lugoch@3tentos.com.br":["Ijui","Ajuricaba","Boa Vista do Cadeado","Catuipe","Coronel Barros","Maua","Campo Novo","Três de Maio","Horizontina"],
"giovane.lopes@tentoscap.com.br":["Santo Augusto","Chiapetta","Eugenio de Castro","Giruá","Entre-Ijuis","São Luiz Gonzaga","Santo Antônio das Missões"],
"alexandre.rocha@3tentos.com.br":["Augusto Pestana","Capão do Cipó","Joia","Santiago","Condor","Panambi","Julio de Castilhos","Cruz Alta","Fortaleza dos Valos","Ibiruba","Pejuçara","Tupanciretã"],
"thiago.molina@3tentos.com.br":["Cachoeira do Sul","Santa Maria","São Vicente do Sul"],
"marina.haertel@tentoscap.com.br":["Pelotas","Santa Vitoria do Palmar","Capivari","Camaqua","Canguçu"],
"lorenzo.bratta@tentoscap.com.br":["Alegrete","Uruguaiana","Bagé","Dom Pedrito","Rosário do Sul","São Borja","São Gabriel"],
"carlos.meurer@3tentos.com.br":["Alta Floresta","Matupa"],
"matheus.poletto@tentoscap.com.br":["Porto dos Gauchos","Sinop"],
"jessica.paula@3tentos.com.br":["Nova Ubiratã","Sorriso"],
"joao.junior@3tentos.com.br":["Confresa"],
"fabricio.santos@3tentos.com.br":["São Felix do Araguaia","Querência","Água Boa"]
};

// CSV input
document.getElementById("csvFileInput").addEventListener("change", e=>csvFile=e.target.files[0]);

async function runCSV(){
  if(!csvFile){ alert("Escolha um arquivo CSV"); return; }

  const reader = new FileReader();
  reader.onload = async e => {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if(lines.length < 2){ alert("CSV vazio ou sem dados válidos"); return; }

    // separador ;
    const headers = lines[0].split(";").map(h => h.trim());
    const batchAdd = [];

    for(let i = 1; i < lines.length; i++){
      const values = lines[i].split(";").map(v => v.trim());
      if(values.length !== headers.length) continue;

      const cardData = {};

      headers.forEach((h, idx) => {
        let val = values[idx];

        // limpar valores monetários e porcentagem apenas para campos numéricos
        if((h.includes("Limite") && !h.toLowerCase().includes("status")) || h.includes("%")){
          val = val.replace(/[R$%]/g,"").replace(",",".");
          val = Number(val) || 0;
        }

        // converter datas
        if(h.toLowerCase().includes("vencimento")){
          const partes = val.split("/");
          if(partes.length === 3) val = `${partes[2]}-${partes[1].padStart(2,"0")}-${partes[0].padStart(2,"0")}`;
          else val = "";
        }

        // nomes simplificados para Firestore
        const keyMap = {
          "Cliente":"nome",
          "CPF":"cpf",
          "User ID":"userId",
          "Status Logistico":"statusLogistico",
          "Status Limite":"statusLimite",
          "Area Plantada":"areaPlantada",
          "Regional":"regional",
          "Unidade 3Tentos":"unidade",
          "Assessor":"assessor",
          "Limite Concedido":"limiteConcedido",
          "Limite Disponivel":"limiteDisponivel",
          "% do Limite Disponivel":"percentDisponivel",
          "Vencimento do limite":"vencimento"
        };

        const key = keyMap[h] || h;
        cardData[key] = val; // statusLimite permanece string
      });

      batchAdd.push(cardData);
    }

    if(batchAdd.length === 0){ alert("Nenhum registro válido encontrado no CSV"); return; }

    try{
      for(const c of batchAdd){
        await addDoc(collection(db,"Cartao"), c);
      }
      alert(`Importação concluída! ${batchAdd.length} cartões adicionados.`);
      csvFile = null;
      document.getElementById("csvFileInput").value = "";
      if(window.carregarCartoes) await window.carregarCartoes();
    } catch(err){
      alert("Erro ao importar CSV: " + err.message);
    }
  };

  reader.readAsText(csvFile);
}


// Login
async function login(){
  const email=document.getElementById("inputEmail").value;
  const pass=document.getElementById("inputPassword").value;
  document.getElementById("loginError").textContent="";
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,pass);
    currentUserEmail=email.toLowerCase();
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("userEmailDisplay").textContent=email;
    document.getElementById("logoutBtn").classList.remove("hidden");
    document.getElementById("appSection").classList.remove("hidden");
    document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
    await carregarCartoes();
  }catch(err){document.getElementById("loginError").textContent=err.message;}
}

async function logout(){
  await signOut(auth);
  document.getElementById("loginSection").classList.remove("hidden");
  document.getElementById("appSection").classList.add("hidden");
  document.getElementById("userEmailDisplay").textContent="";
  document.getElementById("logoutBtn").classList.add("hidden");
}

// Form
function showAddForm(){document.getElementById("cardForm").classList.remove("hidden");}
function hideAddForm(){document.getElementById("cardForm").classList.add("hidden");}

async function saveCard(){
  const data={
    nome: document.getElementById("f_nome").value,
    cpf: document.getElementById("f_cpf").value,
    regional: document.getElementById("f_regional").value,
    unidade: document.getElementById("f_unidade").value,
    assessor: document.getElementById("f_assessor").value,
    areaPlantada: document.getElementById("f_areaPlantada").value,
    limiteConcedido: Number(document.getElementById("f_limiteConcedido").value||0),
    limiteDisponivel: Number(document.getElementById("f_limiteDisponivel").value||0),
    statusLogistico: document.getElementById("f_statusLogistico").value,
    statusLimite: document.getElementById("f_statusLimite").value,
    vencimento: document.getElementById("f_vencimento").value
  };
  try{
    await addDoc(collection(db,"Cartao"),data);
    alert("Cartão salvo com sucesso!");
    hideAddForm();
    await carregarCartoes();
  }catch(err){document.getElementById("formMsg").textContent=err.message;}
}

// Carregar cartões
async function carregarCartoes(){
  const tbody=document.getElementById("cardsTbody");
  tbody.innerHTML="";
  const snapshot=await getDocs(collection(db,"Cartao"));
  const allowedUnits=userUnitsMap[currentUserEmail]||[];
  snapshot.forEach(docSnap=>{
    const d=docSnap.data();
    if(allowedUnits.length && !allowedUnits.includes(d.unidade)) return;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.nome||""}</td>
      <td>${d.cpf||""}</td>
      <td>${d.statusLogistico||""}</td>
      <td>${d.statusLimite||""}</td>
      <td>${d.areaPlantada||""}</td>
      <td>${d.regional||""}</td>
      <td>${d.unidade||""}</td>
      <td>${d.assessor||""}</td>
      <td>${d.limiteConcedido||0}</td>
      <td>${d.limiteDisponivel||0}</td>
      <td>${d.limiteConcedido?Math.round((d.limiteDisponivel/d.limiteConcedido)*100):0}%</td>
      <td>${d.vencimento?new Date(d.vencimento).toLocaleDateString("pt-BR"):""}</td>
      <td>
        <button onclick="deleteCard('${docSnap.id}')">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function deleteCard(id){
  if(!confirm("Deseja realmente excluir este cartão?")) return;
  await deleteDoc(doc(db,"Cartao",id));
  await carregarCartoes();
}

async function deleteAllExceptProtected(){
  if(!confirm("Deseja realmente excluir todos os cartões?")) return;
  const snapshot=await getDocs(collection(db,"Cartao"));
  for(const d of snapshot.docs) await deleteDoc(doc(db,"Cartao",d.id));
  await carregarCartoes();
}

window.runCSV=runCSV;
window.login=login;
window.logout=logout;
window.showAddForm=showAddForm;
window.hideAddForm=hideAddForm;
window.saveCard=saveCard;
window.carregarCartoes=carregarCartoes;
window.deleteCard=deleteCard;
window.deleteAllExceptProtected=deleteAllExceptProtected;
</script>
</body>
</html>

